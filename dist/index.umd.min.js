!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("qiniu-js"),require("crypto")):"function"==typeof define&&define.amd?define(["qiniu-js","crypto"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).Qiniu=t(e.qiniu,e.crypto)}(this,(function(e,t){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function r(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var o=r(e),i=n(t);function u(e,t,n,r,o,i,u){try{var a=e[i](u),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function a(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){u(i,r,o,a,c,"next",e)}function c(e){u(i,r,o,a,c,"throw",e)}a(void 0)}))}}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const f=new Uint8Array(256);let l=f.length;function s(){return l>f.length-16&&(i.default.randomFillSync(f),l=0),f.slice(l,l+=16)}var p=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const g=[];for(let e=0;e<256;++e)g.push((e+256).toString(16).substr(1));function v(e,t=0){const n=(g[e[t+0]]+g[e[t+1]]+g[e[t+2]]+g[e[t+3]]+"-"+g[e[t+4]]+g[e[t+5]]+"-"+g[e[t+6]]+g[e[t+7]]+"-"+g[e[t+8]]+g[e[t+9]]+"-"+g[e[t+10]]+g[e[t+11]]+g[e[t+12]]+g[e[t+13]]+g[e[t+14]]+g[e[t+15]]).toLowerCase();if(!function(e){return"string"==typeof e&&p.test(e)}(n))throw TypeError("Stringified UUID is invalid");return n}function d(e,t,n){const r=(e=e||{}).random||(e.rng||s)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return v(r)}function h(e,t){var n;for(n in t)e[n]=e[n]&&"[object Object]"===e[n].toString()?h(e[n],t[n]):e[n]=t[n];return e}var m=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.opts=h({async:!1,root:"",domain:"",token:"",iat:"",exp:60,rename:!0,putExtra:{},config:{},getConfig:function(){},getToken:function(){}},t),this.configComplete=!1}var t,n,r;return t=e,n=[{key:"_init",value:function(){var e=this;return new Promise(function(){var t=a(regeneratorRuntime.mark((function t(n,r){var o,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:null!==(o=e.opts)&&void 0!==o&&o.async?e.configComplete?n():null===(i=e.opts)||void 0===i||i.getConfig().then((function(t){e.opts=h(e.opts,t),e.configComplete=!0,n()})).catch((function(){e.configComplete=!1,r()})):(e.configComplete=!0,n());case 1:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}())}},{key:"upload",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise((function(i,u){n._init().then(a(regeneratorRuntime.mark((function a(){var c,f,l,s;return regeneratorRuntime.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return console.log("configComplete",n.configComplete),a.next=3,n._getToken();case 3:a.sent&&(f=h(n.opts,{config:r}),e=n._generateKey({key:e,rename:null==f?void 0:f.rename}),l=o.upload(t,e,null==f?void 0:f.token,null===(c=n.opts)||void 0===c?void 0:c.putExtra,null==f?void 0:f.config),s=l.subscribe({next:function(e){var t,r,o;"[object Function]"===Object.prototype.toString.call(null==f||null===(t=f.config)||void 0===t?void 0:t.next)&&(null==f||null===(r=f.config)||void 0===r||null===(o=r.next)||void 0===o||o.call(n,e,s))},error:function(e){u(e)},complete:function(e){var r=e.key,o=e.hash;i({code:200,data:{hash:o,key:r,suffix:n._getSuffix(r),url:n._getUrl(r),size:null==t?void 0:t.size}})}}));case 5:case"end":return a.stop()}}),a)}))))}))}},{key:"_getToken",value:function(){var e=this;return new Promise(function(){var t=a(regeneratorRuntime.mark((function t(n,r){var o,i,u,a;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e._validateToken()){t.next=9;break}return t.next=4,e.opts.getToken().catch((function(){r()}));case 4:o=t.sent,i=o.token,u=o.iat,a=o.exp,e.opts=h(e.opts,{token:i,iat:u,exp:a});case 9:n(!0);case 10:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}())}},{key:"_getSuffix",value:function(e){return e.substring(e.lastIndexOf("."),e.length)}},{key:"_getUrl",value:function(e){return this._formatPath("".concat(this.opts.domain,"/").concat(e))}},{key:"_formatPath",value:function(e){var t=e.match(new RegExp("^((https|http|ftp|rtsp|mms))://","g"));return(t&&t.length?t[0]:"")+e.replace(t,"").replace(new RegExp("/{2,}","g"),"/").replace(new RegExp("^/"),"")}},{key:"_validateToken",value:function(){var e=this.opts,t=e.token,n=e.exp,r=e.iat;return!(!t||!n||(new Date).getTime()>r+60*n*1e3)}},{key:"_generateKey",value:function(e){var t=e.key,n=e.rename;if(!t)return null;var r=t.substring(0,t.lastIndexOf("/")),o=n?"".concat(r,"/").concat(d()).concat(this._getSuffix(t)):t;return this._formatPath("".concat(this.opts.root,"/").concat(o))}}],n&&c(t.prototype,n),r&&c(t,r),e}();return m}));
